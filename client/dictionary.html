<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/style.css">
    <title>Dictionary</title>
    <style>
        textarea { width: 100%; height: 100px; }
        .hidden { display: none; }
    </style>
</head>
<body>



<div class="container">
    <h2>Dictionary: <span id="dictLanguage"></span></h2>


<!-- Single word add -->
<input id="word" placeholder="Word">
<input id="translation" placeholder="Translation">
<button class="btn-primary" onclick="addWord()">Add Word</button>


<hr>

<!-- Multiple words -->
<button onclick="showMultiAdd()">Add multiple words</button>

<div id="multiAddBox" class="hidden">
    <h3>Paste words or sentences</h3>
    <textarea id="multiInput" placeholder="Paste text here..."></textarea>
    <br>
    <button onclick="prepareMultiWords()">Add translations for new words</button>
</div>

<div id="translationBox" class="hidden">
    <h3 id="translateTitle"></h3>
    <p><strong id="currentWord"></strong></p>
    <input id="multiTranslation" placeholder="Enter translation">
    <br><br>
    <button onclick="saveCurrentTranslation()">Save & Next</button>
</div>

<hr>

<h3>Words</h3>
<ul id="wordList"></ul>

<script>
const dictionaryId = localStorage.getItem("dictionary_id");
const language = localStorage.getItem("dictionary_language");
document.getElementById("dictLanguage").textContent = language;

let newWords = [];
let currentIndex = 0;

/* ---------------- LOAD WORDS ---------------- */

async function loadWords() {
    const res = await fetch(`http://127.0.0.1:5000/get_words/${dictionaryId}`);
    const words = await res.json();

    const list = document.getElementById("wordList");
    list.innerHTML = "";

    words.forEach(w => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.className = "word-text";
        span.textContent = `${w.word} â†’ ${w.translation}`;
        li.appendChild(span);


        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = async () => {
            const newWord = prompt("New word:", w.word);
            const newTranslation = prompt("New translation:", w.translation);
            if(newWord && newTranslation) {
                await fetch(`http://127.0.0.1:5000/edit_word/${w.id}`, {
                    method: "PUT",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({word: newWord, translation: newTranslation})
                });
                loadWords();
            }
        };
        li.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
            if(confirm("Delete this word?")) {
                await fetch(`http://127.0.0.1:5000/delete_word/${w.id}`, {method:"DELETE"});
                loadWords();
            }
        };
        li.appendChild(delBtn);

        list.appendChild(li);
    });
}

/* ---------------- SINGLE ADD ---------------- */

async function addWord() {
    const word = document.getElementById("word").value.trim();
    const translation = document.getElementById("translation").value.trim();
    if(!word || !translation) return alert("Enter both word and translation");

    const res = await fetch("http://127.0.0.1:5000/add_word", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({dictionary_id: dictionaryId, word, translation})
    });
    const data = await res.json();

    if(data.status==="success") {
        document.getElementById("word").value = "";
        document.getElementById("translation").value = "";
        loadWords();
    } else {
        alert("Error: " + data.message);
    }
}

/* ---------------- MULTI ADD ---------------- */

function showMultiAdd() {
    document.getElementById("multiAddBox").classList.toggle("hidden");
}

function prepareMultiWords() {
    const text = document.getElementById("multiInput").value;

    if(!text.trim()) {
        alert("Paste some text first");
        return;
    }

    // Split text into words
    const cleaned = text
        .toLowerCase()
        .replace(/[^\p{L}\s]/gu, "")
        .split(/\s+/)
        .filter(w => w.length > 0);

    newWords = [...new Set(cleaned)];
    currentIndex = 0;

    if(newWords.length === 0) {
        alert("No valid words found");
        return;
    }

    document.getElementById("multiAddBox").classList.add("hidden");
    document.getElementById("translationBox").classList.remove("hidden");
    showCurrentWord();
}

function showCurrentWord() {
    document.getElementById("multiTranslation").value = "";
    document.getElementById("currentWord").textContent = newWords[currentIndex];
    document.getElementById("translateTitle").textContent =
        `Word ${currentIndex + 1} of ${newWords.length}`;
}

async function saveCurrentTranslation() {
    const translation = document.getElementById("multiTranslation").value.trim();
    if(!translation) {
        alert("Please enter a translation");
        return;
    }

    const word = newWords[currentIndex];

    await fetch("http://127.0.0.1:5000/add_word", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            dictionary_id: dictionaryId,
            word: word,
            translation: translation
        })
    });

    currentIndex++;

    if(currentIndex < newWords.length) {
        showCurrentWord();
    } else {
        alert(`Added ${newWords.length} words successfully`);
        document.getElementById("translationBox").classList.add("hidden");
        document.getElementById("multiInput").value = "";
        loadWords();
    }
}

/* ---------------- INIT ---------------- */

loadWords();
</script>
</body>
</html>
</div>
</body>

